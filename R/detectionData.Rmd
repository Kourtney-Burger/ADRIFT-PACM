---
title: "PACM Detections"
author: "Kourtney Burger"
date: "2024-04-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Packages & Set Working Directory
## Load Packages
```{r}
library(here)
library(xlsx)
library(openxlsx)
library(tidyverse)
library(dplyr)
```

## Set Working Directory
```{r}
DepDir <- here::here()
```

# Taiki's helper function for dates

Helper function to create all the "YYYY-MM-DDThh:mm:ssZ" formatted date strings that JSON will want. *Note that this requires that you convert all your dates in the deploy details data that you read in earlier (or anywhere else you might read dates from) to POSIXct format.*
```{r}
posixToText <- function(x) {
    format(x, '%Y-%m-%dT%H:%M:%S')
}
```

# Read in Data
## Read in template
```{r}
Template <- xlsx::read.xlsx(here::here('PACM Templates/SWFSC_YYYYMMDD_DETECTIONDATA.xlsx'), sheetName = 'Detection_Data_Template')
```

## Read Detection data
```{r}
allDetections <- read.csv(here::here('R/detections/AllDetections_wGPS.csv'))
```

# Clean Detection Data

##Subset Detection Data
```{r}
# Subset PACM fields
detections <- subset(allDetections, select = c('UTC', 'end', 'species', 'call', 'DriftName'))
```

## Convert Species Names to PACM Species Codes (from Taiki)
```{r}
detRename <- tribble(
    ~old, ~new,
    'B. borealis', 'SEWH', #Sei whale
    'Ba', 'MIWH', #Minke whale (common)
    'minke','MIWH', #Minke whale (common)
    'Bm', 'BLWH', #Blue whale
    'Bp', 'FIWH', #Fin whale
    'Bp 40-50 Hz', 'FIWH', #Fin whale
    'fin','FIWH', #Fin whale
    'gray','GRWH', #Gray whale
    'humpback','HUWH', #Humpback whale
    'Mn','HUWH', #Humpback whale
    'PM', 'SPWH', #Sperm whale
    'Pm', 'SPWH', #Sperm whale
    'Lo', 'PWDO', #Pacific white-sided dolphin
    'Gg', 'GRAM', #Risso's dolphin
    'ZC', 'GOBW', #Cuvier's beaked whale
    'BW', 'UNME', #Unidentified Beaked whale, Hyperoodontidae
    'UO', 'UNDO', #Unidentified dolphin, Odontoceti

#Add to PACM        
    'Anthro', 'ANTHRO', 
    'BB', 'BB', #beaked whale, Bairds/Berardius bairdii?  
    'BW43', 'BW43', #Unidentified Beaked whale 43kHz  
    'BWC', 'BWC', #Cross Beaked whale (Cross Seamount),  
    'MC', 'MC', #Hubb's/Mesoplodon carlhubbsi, formerly known as beaked whale 37V kHz 
    'MS', 'MS', #beaked whale, Stejneger's/Mesoplodon stejnegeri 
    'NBHF','NBHF', #Kogia, Dall's, and Harbor porpoise 
)

#Rename species
for(i in 1:nrow(detRename)) {
    detections$species[detections$species == detRename$old[i]] <- detRename$new[i]
}

#Check species codes
#sort(unique(detections$species))
```

## Convert Call Type to PACM Call Type Codes
```{r}
# Set up progress bar
pb <- txtProgressBar(min = 0,      # Minimum value of the progress bar
                     max = nrow(detections), # Maximum value of the progress bar
                     style = 3,    # Progress bar style (also available style = 1 and style = 2)
                     width = 50,   # Progress bar width. Defaults to getOption("width")
                     char = "=")   # Character used to create the bar

#Add sperm whale click call type
for (i in 1:nrow(detections)) {
  if (detections$species[i] == "SPWH") {
    if (is.na(detections$call[i]) || detections$call[i] == "Clicks") {
      detections$call[i] <- "SPUSC"
    }
  } 
  # Sets the progress bar to the current state
  setTxtProgressBar(pb, i)
}
close(pb) # Close the connection


#Clean call types attributed to multiple species
# odontocete 'clicks'
for (i in 1:nrow(detections)) { 
  if (detections$species[i] == "PWDO" || detections$species[i] == "GRAM") {
    if (detections$call[i] == "Clicks" || detections$call[i] == "clicks") {
      detections$call[i] <- "ODCLICK"
    }
  }
  # Sets the progress bar to the current state
  setTxtProgressBar(pb, i)
}
close(pb) # Close the connection


# 'DS' - downsweeps (Sei, Blue, and Fin)
for (i in 1:nrow(detections)) { 
  #Sei (also correcting one PASCAL event mislabeled "Tonal w/Harm)
  if (detections$species[i] == "SEWH") {
    if (detections$call[i] == "DS" || detections$call[i] == "Tonal w/Harm") {
      detections$call[i] <- "SWDS"
    }
  }
}

for (i in 1:nrow(detections)) {   
  #Blue - ADD TO PACM
  if (detections$species[i] == "BLWH") {
    if (detections$call[i] == "DS") {
      detections$call[i] <- "BLDS" 
    }
  }
}

# NOT WORKING: I think this is getting hung up because there are fin whale detections with NA as the call type
for (i in 1:nrow(detections)) { # temporarily correcting this na problem
  if (detections$species[i] == "FIWH") {
    if (is.na(detections$call[i])) {
      detections$call[i] <- "FWUND"
    }
  }
}

for (i in 1:nrow(detections)) {
  #Fin
  if (detections$species[i] == "FIWH") {
    if (detections$call[i] == "DS") {
      detections$call[i] <- "FWDS"
    }
  }
}


# 'Varied' Multiple species, humpback and blue
for (i in 1:nrow(detections)) {   
  #Humpback - HWMIX
  if (detections$species[i] == "HUWH") {
    if (detections$call[i] == "Varied") {
      detections$call[i] <- "HWMIX" 
    }
  }
}

for (i in 1:nrow(detections)) {   
  #Blue - ADD TO PACM BLMIXNEP
  if (detections$species[i] == "BLWH") {
    if (detections$call[i] == "Varied") {
      detections$call[i] <- "BLMIXNEP" 
    }
  }
}


# 'Tonal w/Harm' Multiple species, humpback and sei
    # Sei event corrected above
    # Humpback event also mislabeled corrected here, check with Kaitlin
for (i in 1:nrow(detections)) {   
  if (detections$species[i] == "HUWH") {
    if (detections$call[i] == "Tonal w/Harm") {
      detections$species[i] <- "SEWH"
      detections$call[i] <- "SWDS"
    }
  }
}

# 'regular', humpback and gray, this was a mistake. All 'regular' humpback should be grouped into song, social, or mixed (Kaitlin working on this). All gray detections will be potential/undefined
for (i in 1:nrow(detections)) {
  if (detections$species[i] == "GRWH") {
    if (detections$call[i] == "regular") {
      detections$call[i] <- "GRWHPOT"
    }
  }
}

#Temporarily correcting humpback regular data
for (i in 1:nrow(detections)) {
  if(detections$species[i] == "HUWH") {
   if(detections$call[i] == "regular") {
     detections$call[i] <- "HWUND"
   } 
  }
}

```

```{r}
# Rename call types
callTypeRename <- tribble(
    ~old, ~new,
    '20Hz','FWPLS', #Fin 20 Hz
    'Pulses','FWPLS', #Fin 20 Hz pulses from Liz
    '40Hz','FWDS', #Fin 40 Hz
    'Bp 40-50 Hz', 'FWDS', #Fin 40-50 Hz from Liz
   
    'clicks/A','ACLICKT', #Pacific White sided clicks
    'Clicks/A','ACLICKT', #Pacific White sided clicks
    'clicks/B','BCLICKT', #Pacific White sided clicks
    'Clicks/B','BCLICKT', #Pacific White sided clicks
    
    'Slow Clicks','SPSLC', #Sperm whale clicks
#    '','SPUSC', #Sperm whale clicks
    
    'social','HWSOC', #Humpback social calls
    'song','HWSONG', #Humpback song 
    
    'Ship/Broadband','NONBIO', #no PACM species for anthro sounds???
    'Ship/Low Frequency','NONBIO', #no PACM species for anthro sounds???
    'Ship/Narrowband','NONBIO', #no PACM species for anthro sounds???

    'Whistle','ODWHIS', #use ODWHIS for all whistles 
    'Whistles/<10kHz','ODWHIS', #use ODWHIS for all whistles 
    'Whistles/<5kHz','ODWHIS', #use ODWHIS for all whistles 
    'Whistles/>10kHz','ODWHIS', #use ODWHIS for all whistles 
    'whistles','ODWHIS', #use ODWHIS for all whistles 
    'Whistles','ODWHIS', #use ODWHIS for all whistles 

# Beaked whale call types 
    '','FMUS',
    
# Add to PACM
    'A NE Pacific','BLANEP', # Blue A call, need to add to PACM
    'B NE Pacific','BLBNEP', # Blue B call, need to add to PACM
    'D','BLDNEP', # Blue D call, need to add to PACM
    'Tonal only','BLTONNEP', #Blue tonal calls from Liz (D call? Cory is checking these events)
    'B','MWNEPBOING', #Minke boing, need to add to PACM
    'Boing','MWNEPBOING', #Minke boing, need to add to PACM
    'CB','MWNEPBOING', #Minke boing cutoff, need to add to PACM
)

#Rename call types
for(i in 1:nrow(callTypeRename)) {
    detections$call[detections$call == callTypeRename$old[i]] <- callTypeRename$new[i]
}

#Check call type codes
sort(unique(detections$call))

#Export data for checking
#write.csv(detections, file = "detections.csv", row.names = FALSE)
```



## Convert Times
```{r}
detections$UTC <- posixToText(as.POSIXct(detections$UTC, format = "%Y-%m-%d %H:%M:%S", tz = 'UTC'))

detections$end <- posixToText(as.POSIXct(detections$end, format = "%Y-%m-%d %H:%M:%S", tz = 'UTC'))
```


## Subset Project
```{r}
detections <- detections[str_detect(detections$DriftName, "ADRIFT"),]
```

## Create PACM Dataframe
```{r}
# Add additional PACM Columns
PACMdetections <- detections %>% 
  add_column('ANALYSIS_PERIOD_EFFORT_SECONDS' = '86400', 'ANALYSIS_TIME_ZONE' = 'UTC', 'ACOUSTIC_PRESENCE' = '', 'N_VALIDATED_DETECTIONS' = '', 'DETECTION_METHOD' = '', 'PROTOCOL_REFERENCE' = '', 'DETECTION_SOFTWARE_NAME' = '', 'DETECTION_SOFTWARE_VERSION' = '', 'MIN_ANALYSIS_FREQUENCY_RANGE_HZ' = '', 'MAX_ANALYSIS_FREQUENCY_RANGE_HZ' = '', 'ANALYSIS_SAMPLING_RATE_HZ' = '', 'QC_PROCESSING' = 'Archival', 'LOCALIZED_LATITUDE' = '', 'LOCALIZED_LONGITUDE' = '', 'DETECTION_DISTANCE_M' = '', 'LOCALIZATION_DISTANCE_METHOD' = '', 'LOCALIZATION_DISTANCE_PROTOCOL' = '')

# Reorder Columns
PACMdetections <- PACMdetections[, c(5,1,2,6,7,3,8,9,4,10,11,12,13,14,15,16,17,18,19,20,21,22)]

# Rename Columns

PACMdetections <- PACMdetections %>%
  dplyr::rename(UNIQUE_ID = DriftName, ANALYSIS_PERIOD_START_DATETIME = UTC, ANALYSIS_PERIOD_END_DATETIME = end, SPECIES_CODE = species, CALL_TYPE_CODE = call)
```

## Rename UNIQUE_ID
Need to match current detections 'UNIQUE_ID' to the metadata 'UNIQUE_ID'
```{r}
# Read in metadata
metadata <- read.csv(here::here('PACM Worksheets/ADRIFT/SWFSC_20240410_METADATA.csv'))


```

## Pull Sampling Rate from Metadata
```{r}
# Need to figure out how to match get this from the metadata
#PACMdetections$ANALYSIS_SAMPLING_RATE_HZ[i] == "From Metadata" 
```


# Tidy Detections
## Minke
```{r}
# No minkes in adrift
for (i in 1:nrow(PACMdetections)) {
  if (PACMdetections$SPECIES_CODE[i] == "MIWH") {
    PACMdetections$ACOUSTIC_PRESENCE[i] == "D"
    PACMdetections$DETECTION_METHOD[i] == "PAMGuard GPL"
    PACMdetections$PROTOCOL_REFERENCE[i] == "Unpublished"
    PACMdetections$DETECTION_SOFTWARE_NAME[i] == "PAMGuard"
    PACMdetections$DETECTION_SOFTWARE_VERSION[i] == "2.02.02"
    PACMdetections$MIN_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "0"
    PACMdetections$MAX_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "12000"
  }
}
```

## Blue
```{r}
for (i in 1:nrow(PACMdetections)) {
  if (PACMdetections$SPECIES_CODE[i] == "BLWH") {
    PACMdetections$ACOUSTIC_PRESENCE[i] == "D"
    PACMdetections$DETECTION_METHOD[i] == "PAMGuard GPL"
    PACMdetections$PROTOCOL_REFERENCE[i] == "Unpublished"
    PACMdetections$DETECTION_SOFTWARE_NAME[i] == "PAMGuard"
    PACMdetections$DETECTION_SOFTWARE_VERSION[i] == "2.02.02"
    PACMdetections$MIN_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "0"
    PACMdetections$MAX_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "12000"
  }
}
```

## Brydes
```{r}
for (i in 1:nrow(PACMdetections)) {
  if (PACMdetections$SPECIES_CODE[i] == "") {
    PACMdetections$ACOUSTIC_PRESENCE[i] == ""
    PACMdetections$DETECTION_METHOD[i] == ""
    PACMdetections$PROTOCOL_REFERENCE[i] == ""
    PACMdetections$DETECTION_SOFTWARE_NAME[i] == ""
    PACMdetections$DETECTION_SOFTWARE_VERSION[i] == ""
    PACMdetections$MIN_ANALYSIS_FREQUENCY_RANGE_HZ[i] == ""
    PACMdetections$MAX_ANALYSIS_FREQUENCY_RANGE_HZ[i] == ""
  }
}
```

## Sei
```{r}
for (i in 1:nrow(PACMdetections)) {
  if (PACMdetections$SPECIES_CODE[i] == "MIWH") {
    PACMdetections$ACOUSTIC_PRESENCE[i] == "D"
    PACMdetections$DETECTION_METHOD[i] == "PAMGuard GPL"
    PACMdetections$PROTOCOL_REFERENCE[i] == "Unpublished"
    PACMdetections$DETECTION_SOFTWARE_NAME[i] == "PAMGuard"
    PACMdetections$DETECTION_SOFTWARE_VERSION[i] == "2.02.02"
    PACMdetections$MIN_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "0"
    PACMdetections$MAX_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "12000"
  }
}
```

## Fin
```{r}
for (i in 1:nrow(PACMdetections)) {
  if (PACMdetections$SPECIES_CODE[i] == "MIWH") {
    PACMdetections$ACOUSTIC_PRESENCE[i] == "D"
    PACMdetections$DETECTION_METHOD[i] == "PAMGuard GPL"
    PACMdetections$PROTOCOL_REFERENCE[i] == "Unpublished"
    PACMdetections$DETECTION_SOFTWARE_NAME[i] == "PAMGuard"
    PACMdetections$DETECTION_SOFTWARE_VERSION[i] == "2.02.02"
    PACMdetections$MIN_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "0"
    PACMdetections$MAX_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "12000"
  }
}
```

## Gray
```{r}
for (i in 1:nrow(PACMdetections)) {
  if (PACMdetections$SPECIES_CODE[i] == "MIWH") {
    PACMdetections$ACOUSTIC_PRESENCE[i] == "D"
    PACMdetections$DETECTION_METHOD[i] == "PAMGuard GPL"
    PACMdetections$PROTOCOL_REFERENCE[i] == "Unpublished"
    PACMdetections$DETECTION_SOFTWARE_NAME[i] == "PAMGuard"
    PACMdetections$DETECTION_SOFTWARE_VERSION[i] == "2.02.02"
    PACMdetections$MIN_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "0"
    PACMdetections$MAX_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "12000"
  }
}
```

## Humpback
```{r}
for (i in 1:nrow(PACMdetections)) {
  if (PACMdetections$SPECIES_CODE[i] == "MIWH") {
    PACMdetections$ACOUSTIC_PRESENCE[i] == "D"
    PACMdetections$DETECTION_METHOD[i] == "PAMGuard GPL"
    PACMdetections$PROTOCOL_REFERENCE[i] == "Unpublished"
    PACMdetections$DETECTION_SOFTWARE_NAME[i] == "PAMGuard"
    PACMdetections$DETECTION_SOFTWARE_VERSION[i] == "2.02.02"
    PACMdetections$MIN_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "0"
    PACMdetections$MAX_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "12000"
  }
}
```

## NBHF
```{r}
for (i in 1:nrow(PACMdetections)) {
  if (PACMdetections$SPECIES_CODE[i] == "MIWH") {
    PACMdetections$ACOUSTIC_PRESENCE[i] == "D"
    PACMdetections$DETECTION_METHOD[i] == "PAMGuard GPL"
    PACMdetections$PROTOCOL_REFERENCE[i] == "Unpublished"
    PACMdetections$DETECTION_SOFTWARE_NAME[i] == "PAMGuard"
    PACMdetections$DETECTION_SOFTWARE_VERSION[i] == "2.02.02"
    PACMdetections$MIN_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "0"
    PACMdetections$MAX_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "12000"
  }
}
```

## Sperm Whales
```{r}
for (i in 1:nrow(PACMdetections)) {
  if (PACMdetections$SPECIES_CODE[i] == "MIWH") {
    PACMdetections$ACOUSTIC_PRESENCE[i] == "D"
    PACMdetections$DETECTION_METHOD[i] == "PAMGuard GPL"
    PACMdetections$PROTOCOL_REFERENCE[i] == "Unpublished"
    PACMdetections$DETECTION_SOFTWARE_NAME[i] == "PAMGuard"
    PACMdetections$DETECTION_SOFTWARE_VERSION[i] == "2.02.02"
    PACMdetections$MIN_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "0"
    PACMdetections$MAX_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "12000"
  }
}
```


## Dolphins
```{r}
for (i in 1:nrow(PACMdetections)) {
  if (PACMdetections$SPECIES_CODE[i] == "MIWH") {
    PACMdetections$ACOUSTIC_PRESENCE[i] == "D"
    PACMdetections$DETECTION_METHOD[i] == "PAMGuard GPL"
    PACMdetections$PROTOCOL_REFERENCE[i] == "Unpublished"
    PACMdetections$DETECTION_SOFTWARE_NAME[i] == "PAMGuard"
    PACMdetections$DETECTION_SOFTWARE_VERSION[i] == "2.02.02"
    PACMdetections$MIN_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "0"
    PACMdetections$MAX_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "12000"
  }
}
```

## Beaked Whales
```{r}
for (i in 1:nrow(PACMdetections)) {
  if (PACMdetections$SPECIES_CODE[i] == "MIWH") {
    PACMdetections$ACOUSTIC_PRESENCE[i] == "D"
    PACMdetections$DETECTION_METHOD[i] == "PAMGuard GPL"
    PACMdetections$PROTOCOL_REFERENCE[i] == "Unpublished"
    PACMdetections$DETECTION_SOFTWARE_NAME[i] == "PAMGuard"
    PACMdetections$DETECTION_SOFTWARE_VERSION[i] == "2.02.02"
    PACMdetections$MIN_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "0"
    PACMdetections$MAX_ANALYSIS_FREQUENCY_RANGE_HZ[i] == "12000"
  }
}
```

# Export Metadata
```{r}
write.csv(detections, "~/GitHub/ADRIFT-PACM/PACM Worksheets/SWFSC_20240410_DETECTIONDATA.csv", row.names=FALSE)
```